# Day2

> 目标：把 `Day1.md` 已经覆盖的“基础引擎与最小可运行（资源管理/主循环/基础敌人移动/基础渲染）”之外，项目目前**所有已实现的玩法、架构、UI、动画、修复点**完整记录在 Day2。

## 1. 架构与工程结构（从单体窗口到 OOP 分层）

### 1.1 核心分层
- **MainWindow（表现层）**
  - 只负责：`paintEvent` 渲染、鼠标事件转发、定时器心跳（30ms）。
  - 不再直接写“游戏规则/刷怪/索敌/碰撞”等逻辑。
- **GameController（交互/界面控制层）**
  - 负责：点击命中判定、HUD 与建造菜单的布局与开关、暂停/倍速/开始等 UI 操作。
- **GameWorld（规则/状态层）**
  - 负责：实体容器与生命周期、更新循环、钱/波次/胜负状态、建造/升级/出售、碰撞与清理。
- **WaveSpawner（波次系统）**
  - 负责：根据时间推进刷怪，避免把刷怪逻辑散落在 MainWindow。

### 1.2 设计模式落地（至少 2 种）
- **State（状态机）**
  - 游戏状态：Start / Running / Paused / Victory / Defeat（由 GameWorld 维护）。
  - UI 渲染与输入响应根据状态分流（开始界面、结算界面、暂停状态等）。
- **Strategy（索敌策略）**
  - `TargetingStrategy` 接口 + `FurthestProgressStrategy` 实现。
  - 塔通过策略选择目标敌人，避免索敌规则写死在 Tower/MainWindow。

## 2. 核心玩法系统（Day1 之外的完整游戏闭环）

### 2.1 炮塔/子弹/索敌
- **塔类型与升级**：Cannon / Poop / Star / Fan（实体与贴图资源齐全）。
- **索敌改为中心点**：塔索敌与命中判定使用目标实体的中心点（更贴近原版）。
- **炮塔朝向旋转**：塔每帧根据目标更新 `rotationDeg`，渲染时使用 `translate -> rotate -> drawPixmap`。
- **子弹运动与命中**：子弹按速度推进，接近目标中心点后触发命中并过期。
- **子弹旋转/速度对齐**：Star/Fan 等子弹具备旋转表现（并与 tick 时间解耦）。

### 2.2 障碍物与塔坑（TowerPit）
- **障碍物实体**：按关卡固定位置生成，具备血量/可被攻击/被摧毁后消失。
- **塔坑选择高亮规则**：地图绿色框默认隐藏，仅在选中塔坑（建造菜单打开）时显示。
- **选中对象管理**：区分选中塔/选中障碍物，便于后续扩展（比如显示血条、信息面板）。

### 2.3 经济系统
- 初始金钱与击杀奖励：击杀不同怪物获得不同金币。
- 被动收入：每秒自动加钱（moneyAccMs 累积）。

### 2.4 波次与胜负条件
- **刷怪系统 WaveSpawner**：采用时间累积/绝对时间调度，不依赖“tick 必须整除”。
- **胜利/失败判定**：
  - 萝卜血量 <= 0 → Defeat。
  - Boss 波次结束且 Boss 已死亡且场上无敌人 → Victory。

## 3. 动画与节奏对齐（尽量贴近 `/.WendyAr`）

### 3.1 敌人走路动画
- 敌人移动时在 `monsterX.png` 与 `monsterX_2.png` 之间来回切换。
- 静止/不移动时不切换（避免“原地抖动”）。
- 增加轻微上下浮动（bobbing）提升动感。

### 3.2 Tick/帧率
- 主循环 tick 固定 **30ms**（提升观感），并修正所有“与 tick 绑定”的逻辑，避免加速或减速导致节奏错误。

### 3.3 炮塔/子弹比例细节
- **Cannon 炮塔缩放规则**：
  - 低等级按 0.5 倍渲染；高等级按 2 倍渲染（渲染层实现，逻辑层保留等级）。
- **Cannon 子弹更大**：保证观感接近原版。

## 4. UI 还原（开始菜单/HUD/建造菜单/按钮）

### 4.1 顶部 HUD
- Money 显示。
- 波次显示（居中），暂停时显示“暂停中”。
- 暂停/倍速按钮使用贴图（hover/normal）。
- 倍速按钮区域大小微调（x1/x2 显示缩小）。

### 4.2 开始界面与交互
- Start 界面透明点击区域（开始/规则等）。
- 结束界面（胜利/失败）与确认按钮逻辑。

### 4.3 建造菜单
- 点击塔坑打开建造菜单；点击建造按钮进行放置。
- 菜单与塔坑的定位使用 top-left 作为锚点，方便像素级对齐。

## 5. 音频（BGM + 音效）

### 5.1 背景音乐（BGM）
- 目标文件：`res/sounds/background_music.mp3`。
- 由于 Qt6 + FFmpeg 下 `qrc:/...` 可能 `InvalidMedia/ResourceError`，改为：
  - 从 `:/sounds/...` 或磁盘候选路径读取为 `QBuffer`。
  - 通过 `QMediaPlayer::setSourceDevice`（Qt6）/ `setMedia(QMediaContent(), device)`（Qt5）播放。
- 增加自检日志输出（status/state/duration/device），用于快速定位“无声”原因。

### 5.2 音效与胜利音乐
- 新增并注册资源：
  - `death_moster.mp3`（怪物死亡）
  - `Win_music.mp3`（胜利/点击）
- **触发位置**：
  - 怪物死亡：GameWorld 在移除死亡怪物时触发一次性标记；MainWindow 在 tick 后消费并播放。
  - 胜利：进入 Victory 的瞬间触发一次性标记；MainWindow 消费并播放。
  - UI 点击：按需求，在 `mousePressEvent` 左键点击时播放一次 `Win_music.mp3`。

## 6. 关键问题与修复（Day2 期间集中处理）

### 6.1 “障碍物被摧毁后子弹乱飞”
- **根因**：子弹追踪障碍物裸指针，障碍物删除后指针悬空。
- **修复**：
  - 删除障碍物前，先让所有追踪它的子弹 `expired` 并清空目标指针。
  - 子弹 update 增加兜底：目标障碍物死亡则子弹过期。

### 6.2 编译/类型/绘制兼容问题
- 处理不完整类型（forward declare 与 include 的边界）。
- 处理 `QRectF`/`QRect` 绘制重载不匹配等问题。
- 调整析构函数 out-of-line，降低头文件耦合。

## 7. 今日验证点（运行确认清单）
- 30ms tick 下整体节奏正常（刷怪/移动/射击不随帧率改变）。
- 敌人移动时两帧贴图交替播放，静止不切换。
- 塔能旋转对准目标、子弹命中按中心点判定。
- 障碍物被打爆后子弹不再乱飞。
- BGM/SFX 在控制台能看到 `... loaded from ...`，且能实际听到声音。
- 胜利时播放胜利音乐；怪物死亡时播放死亡音效；任意 UI 左键点击播放胜利音乐。

## 8. 明日计划（Day3 方向）
- 继续对齐 `/.WendyAr`：UI 像素级对齐、更多动画节奏微调。
- 音频策略优化：暂停/开始界面/结算界面对 BGM 的播放与停止策略。
- 鲁棒性：资源缺失时更友好的提示与降级策略。
